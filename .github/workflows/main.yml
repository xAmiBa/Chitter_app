name: Build and Test

on: push

jobs:
  test:
    runs-on: ubuntu-latest

    services:
        postgres:
            image: chitter
            env:
                POSTGRES_PASSWORD: postgres
            options: >-
                --health-cmd pg_isready
                --health-interval 10s
                --health-timeout 5s
                --health-retries 5

    steps:
      - name: Check out the code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
            python-version: 3.11

      - name: Install dependencies
        run: | 
          python -m pip install --upgrade pip
          pip install pipenv
          pipenv install --dev

      - name: Connect to PostgreSQL
          # Runs a script that creates a PostgreSQL table, populates
          # the table with data, and then retrieves the data.
        run: node client.js
          # Environment variables used by the `client.js` script to create a new PostgreSQL table.
        env:
            # The hostname used to communicate with the PostgreSQL service container
            POSTGRES_HOST: postgres
            # The default PostgreSQL port
            POSTGRES_PORT: 5432
    
    #   - name: install postgres
    #     run: |
    #       sudo apt update
    #       sudo apt install postgresql postgresql-contrib
    #       sudo systemctl start postgresql.service
    #       sudo -i -u postgres

    #   - name: Create and connect to a db
    #     run: |
    #       createdb chitter_test
    #       psql -h localhost -U postgres -d chitter_test


      - name: Update playwright
        run: | 
          pipenv install playwright
          pipenv run playwright install

      - name: Test with pytest
        run: |
          pipenv run pytest